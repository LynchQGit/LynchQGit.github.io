Redis集群间的节点通过Redis Cluster Bus（集群总线）进行消息通信。Redis Cluster Bus主要用于节点间的元数据交换、故障检测和故障恢复等操作。
## Redis Cluster Bus协议
Redis Cluster Bus协议是一种二进制协议，它使用了一种紧凑的二进制消息格式，以减少网络带宽消耗和提高处理速度。
### 消息结构
Redis Cluster Bus协议的消息结构如下：
```
+---------+-------------+---------+----------+----------------+------+--------+
|   大小   |    4 字节   |  2 字节  |  2 字节   |   8 字节       | ...  |  1 字节 |
+---------+-------------+---------+----------+----------------+------+--------+
| 字段名   |   签名       |  版本   |  类型     |    消息长度     | ...  |  校验和 |
+---------+-------------+---------+----------+----------------+------+--------+
| 示例值   | "RCmb"      |  1      |  CLUSTERMSG_TYPE_...      | ...  |        |
+---------+-------------+---------+----------+----------------+------+--------+
```
- 签名（Signature）：标识该消息为Redis Cluster Bus协议的消息，固定为"RCmb"。
- 版本（Version）：协议的版本号，当前为1。
- 类型（Type）：消息类型，如故障检测、配置更新等。
- 消息长度（Message Length）：消息的长度，包括消息头和消息体。
- 校验和（Checksum）：对消息内容进行CRC16校验，用于检测消息在传输过程中是否出错。
### 消息类型
Redis Cluster Bus协议支持多种消息类型，用于处理不同的集群操作：
- PING：节点间发送心跳消息，用于检测其他节点的存活状态。
- PONG：回应PING消息，通知发送者节点自己的存活状态。
- MEET：邀请一个新节点加入集群。
- FAIL：通知集群中的其他节点，某个节点已宕机。
- UPDATE：通知集群中的其他节点，某个节点的元数据已发生变化。
- MFSTART：通知集群中的其他节点，开始进行手动故障转移操作。
- GFAIL：通知集群中的其他节点，某个节点可能已宕机，但尚未确认。
### 通信方式
Redis集群中的每个节点会为集群总线维护一个独立的TCP连接，这些连接组成了一个全连接网络。通过该网络，节点可以高效地将消息广播到集群中的其他节点。
每个节点在启动时会分配一个随机生成的48位节点ID，用于在集群总线中标识自己。节点间的通信消息会包含发送者和接收者的节点ID，以指定消息的来源和目的地。
## 示例
例如，当一个新节点需要加入集群时，它会向集群中的一个已有节点发送MEET消息。收到MEET消息的节点会将新节点的信息添加到自己的节点表，并将MEET消息广播给集群中的其他节点。其他节点收到MEET消息后，也会将新节点的信息添加到自己的节点表，从而完成新节点的加入。
